# Azure DevOps Pipeline to Configure the Indy Nodes

This pipeline will run the Ansible Playbook in the [CANDy repository](https://github.com/CQEN-QDCE/Candy), and save the secrets generated by the `init` command into an Azure Key Vault.

## Prerequisites

In order to run the pipeline you must have the following prerequisites in place:

* the ssh key, and the inventory file need to be base64 encoded and stored
  in a key vault
* a service principal and service connection must be configured to run the
  pipeline, and also needs permissions to create/update/set keys in the
  specified key vault
* An environment called REGISTRY_NODES, with approvals set up, to control
  when the pipeline is executed

## Pipeline Actions

The pipeline will perform the following actions:

* load the specified secrets from the key vault
* write the ssh key and inventory files in /tmp
* run the playbook to setup the indy node(s)
* save the output of the init command to the key vault
* remove the files from the /tmp directory as it is not run on a self-hosted agent.

### Input Parameters

* Azure DevOps Pipeline Service Connection Name
* Azure Service Principal Password key (saved in the key vault)
* Azure Key Vault name
* Ansible Inventory File key, saved in the key vault
* SSH Private Key for Registry Nodes key, saved in the key vault
* Network Name, Ansible Playbook to use while configuring the node
* Indy Secrets Key Vault Key Name, the key vault key to save the secrets in
