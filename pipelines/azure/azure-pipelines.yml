# Azure DevOps Pipeline to Configure the Indy Nodes
# This pipeline will run the Ansible Playbook in the CANDy repository -- see
# https://github.com/CQEN-QDCE/Candy -- and save the secrets generated by the
# init_indy_node command into an Azure Key Vault.
#
# See the README.md for more information.

trigger:
- none

pool:
  vmImage: ubuntu-latest

parameters:

  - name: AZ_SP_NAME
    type: string
    default: ""
    displayName: Azure Service Connection Name

  - name: AZ_SP_PASSWORD
    type: string
    default: ""
    displayName: Azure Service Principal Password

  - name: AZ_KV_NAME
    type: string
    default: ""
    displayName: Azure Key Vault Name

  - name: ANSIBLE_INVENTORY
    type: string
    default: ""
    displayName: Ansible Inventory File

  - name: SSH_PRIVATE_KEY
    type: string
    default: ""
    displayName: SSH Private Key for Registry Nodes

  - name: INDY_NETWORK_NAME
    type: string
    default: ""
    displayName: Indy Network Name

  - name: INIT_SECRETS_KEY
    type: string
    default: ""
    displayName: Indy Secrets Key Vault Key Name

stages:
  - stage: Configure_Nodes
    jobs:
      - deployment:
        pool:
          vmImage: ubuntu-latest
        displayName: Configure Nodes
        environment: "REGISTRY_NODES"
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureKeyVault@2
                  displayName: 'Get Secrets'
                  inputs:
                    azureSubscription: '${{ parameters.AZ_SP_NAME }}'
                    KeyVaultName: '${{ parameters.AZ_KV_NAME }}'
                    SecretsFilter: '${{ parameters.AZ_SP_PASSWORD }}, ${{ parameters.ANSIBLE_INVENTORY }}, ${{ parameters.SSH_PRIVATE_KEY }}'
                    RunAsPreJob: false

                - task: AzureCLI@2
                  displayName: 'Create Inventory File'
                  inputs:
                    azureSubscription: '${{ parameters.AZ_SP_NAME }}'
                    scriptType: 'pscore'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret show --vault-name ${{ parameters.AZ_KV_NAME }} --name ${{ parameters.ANSIBLE_INVENTORY }} --query value -o tsv | base64 --decode > /tmp/inventory.yml

                - task: AzureCLI@2
                  displayName: 'Create SSH Key File'
                  inputs:
                    azureSubscription: '${{ parameters.AZ_SP_NAME }}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret show --vault-name ${{ parameters.AZ_KV_NAME }} --name ${{ parameters.SSH_PRIVATE_KEY }} --query value -o tsv | base64 --decode > /tmp/private-key.pem && chmod 0600 /tmp/private-key.pem

                - task: Ansible@0
                  displayName: 'Run Ansible Playbook'
                  inputs:
                    ansibleInterface: 'agentMachine'
                    playbookPathOnAgentMachine: '$(Build.SourcesDirectory)/ansible/indy_node/deploy.yml'
                    inventoriesAgentMachine: 'file'
                    inventoryFileOnAgentMachine: '/tmp/inventory.yml'
                    args: '--user validatornode --extra-vars "cloud=azure network_name=${{ parameters.INDY_NETWORK_NAME }} indy_node_channel=rc indy_node_pkg=indy-node indy_node_configuration=true write_node_secrets=true"'

                - task: AzureCLI@2
                  displayName: 'Set init_indy_node Secrets in Key Vault'
                  inputs:
                    azureSubscription: '${{ parameters.AZ_SP_NAME }}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az keyvault secret set --vault-name ${{ parameters.AZ_KV_NAME }} --name ${{ parameters.INIT_SECRETS_KEY }} --value "$(cat /tmp/indy_node_init_results.txt)"

                - task: CmdLine@2
                  displayName: 'Clean-up'
                  inputs:
                    script: |
                      sudo rm /tmp/inventory.yml /tmp/private-key.pem /tmp/indy_node_init_results.txt
                      ls -lah /tmp
